@using CMCS_Part3.Services
@model Claim
@{
    ViewData["Title"] = "Claim Status Tracking";
    var currentUser = ViewData["CurrentUser"] as CurrentUser;
    var statusHistory = ViewData["StatusHistory"] as List<StatusHistory>;
    var statusOverview = ViewData["StatusOverview"] as StatusOverview;
    var estimatedApprovalTime = ViewData["EstimatedApprovalTime"] as string;
    var culture = new System.Globalization.CultureInfo("en-ZA");
    var daysPending = (DateTime.Now - Model.SubmissionDate).Days;
}

<h2>Claim Status Tracking</h2>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="card-title mb-0">Claim #@Model.Id - Status Overview</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Lecturer:</strong> @Model.Lecturer?.Name<br>
                        <strong>Submission Date:</strong> @Model.SubmissionDate.ToString("dd MMMM yyyy")<br>
                        <strong>Claim Month:</strong> @GetMonthName(Model.ClaimMonth)<br>
                        <strong>Total Amount:</strong> <span class="h5 text-success">@Model.TotalAmount.ToString("C", culture)</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Current Status:</strong>
                        <span class="badge @GetStatusBadgeClass(Model.Status) fs-6">@Model.Status</span><br>
                        <strong>Days Pending:</strong> <span class="fw-bold">@daysPending days</span><br>
                        <strong>Estimated Approval:</strong> <span class="fw-bold">@estimatedApprovalTime</span><br>
                        @if (Model.ApprovalDate.HasValue)
                        {
                            <strong>@(Model.Status == ClaimStatus.Approved ? "Approved" : "Rejected") Date:</strong>
                            @Model.ApprovalDate.Value.ToString("dd MMMM yyyy")
                        
                            <br>
                            <strong>@(Model.Status == ClaimStatus.Approved ? "Approved By:" : "Rejected By:")</strong>
                            @Model.ApprovedBy
                        }
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(Model.RejectionReason))
                {
                    <div class="alert alert-danger mt-3">
                        <strong>Rejection Reason:</strong> @Model.RejectionReason
                    </div>
                }

                <!-- Status Progress Bar -->
                <div class="mt-4">
                    <h5>Approval Progress</h5>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar @GetProgressBarClass(Model.Status)"
                             style="width: @GetProgressPercentage(Model.Status)%">
                            @GetProgressText(Model.Status)
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <small>Submitted</small>
                        <small>Under Review</small>
                        <small>@(Model.Status == ClaimStatus.Approved ? "Approved" : "Final Decision")</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status History -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Status History</h5>
            </div>
            <div class="card-body">
                @if (statusHistory != null && statusHistory.Any())
                {
                    <div class="timeline">
                        @foreach (var history in statusHistory.OrderBy(h => h.UpdatedAt))
                        {
                            <div class="timeline-item">
                                <div class="timeline-marker @GetStatusBadgeClass(history.Status)"></div>
                                <div class="timeline-content">
                                    <div class="d-flex justify-content-between">
                                        <strong>@history.Status</strong>
                                        <small class="text-muted">@history.UpdatedAt.ToString("dd MMM yyyy HH:mm")</small>
                                    </div>
                                    <div class="text-muted">
                                        By: @history.UpdatedBy<br>
                                        @if (!string.IsNullOrEmpty(history.Notes))
                                        {
                                            <em>@history.Notes</em>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted">No status history available.</p>
                }
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Quick Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="@Url.Action("Details", new { id = Model.Id })" class="btn btn-outline-primary">
                        <i class="fas fa-eye"></i> View Claim Details
                    </a>
                    <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                        <i class="fas fa-list"></i> Back to My Claims
                    </a>
                    @if (daysPending > 30)
                    {
                        <button class="btn btn-warning">
                            <i class="fas fa-exclamation-triangle"></i> Follow Up Required
                        </button>
                    }
                </div>
            </div>
        </div>

        <!-- Supporting Documents -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Supporting Documents</h5>
            </div>
            <div class="card-body">
                @if (Model.SupportingDocuments.Any())
                {
                    <div class="list-group">
                        @foreach (var doc in Model.SupportingDocuments)
                        {
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-file @GetFileIconClass(doc.FileType)"></i>
                                        <small>@doc.FileName</small>
                                    </div>
                                    <a href="@Url.Content("~/uploads/" + doc.StoredFileName)"
                                       target="_blank" class="btn btn-sm btn-outline-primary">
                                        View
                                    </a>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted">No supporting documents</p>
                }
            </div>
        </div>

        <!-- System Statistics -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">System Overview</h5>
            </div>
            <div class="card-body">
                <div class="small">
                    <strong>Total Claims:</strong> @(statusOverview?.TotalClaims ?? 0)<br>
                    <strong>Pending:</strong> @(statusOverview?.PendingCount ?? 0)<br>
                    <strong>Approved:</strong> @statusOverview?.ApprovedCount ?? 0<br>
                    <strong>Rejected:</strong> @statusOverview?.RejectedCount ?? 0<br>
                    <strong>Overdue:</strong> @statusOverview?.OverdueCount ?? 0<br>
                    <hr>
                    <strong>Your Claims Status:</strong><br>
                    - Pending: @(statusOverview?.PendingCount ?? 0)<br>
                    - Approved: @(statusOverview?.ApprovedCount ?? 0)<br>
                    - Overdue: <span class="text-warning">@(statusOverview?.OverdueCount ?? 0)</span>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        .timeline-marker {
            position: absolute;
            left: -30px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #fff;
        }
        .timeline-content {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 3px solid #007bff;
        }
        .bg-pending { background-color: #ffc107; }
        .bg-approved { background-color: #28a745; }
        .bg-rejected { background-color: #dc3545; }
    </style>
}

@functions {
    string GetMonthName(string monthString)
    {
        if (DateTime.TryParseExact(monthString, "yyyy-MM", null, System.Globalization.DateTimeStyles.None, out var date))
        {
            return date.ToString("MMMM yyyy");
        }
        return monthString;
    }

    string GetStatusBadgeClass(ClaimStatus status)
    {
        return status switch
        {
            ClaimStatus.Pending => "bg-warning",
            ClaimStatus.Approved => "bg-success",
            ClaimStatus.Rejected => "bg-danger",
            _ => "bg-secondary"
        };
    }

    string GetProgressBarClass(ClaimStatus status)
    {
        return status switch
        {
            ClaimStatus.Pending => "bg-warning",
            ClaimStatus.Approved => "bg-success",
            ClaimStatus.Rejected => "bg-danger",
            _ => "bg-secondary"
        };
    }

    int GetProgressPercentage(ClaimStatus status)
    {
        return status switch
        {
            ClaimStatus.Pending => 50,
            ClaimStatus.Approved => 100,
            ClaimStatus.Rejected => 100,
            _ => 0
        };
    }

    string GetProgressText(ClaimStatus status)
    {
        return status switch
        {
            ClaimStatus.Pending => "Under Review (50%)",
            ClaimStatus.Approved => "Approved (100%)",
            ClaimStatus.Rejected => "Rejected (100%)",
            _ => "Unknown"
        };
    }

    string GetFileIconClass(string fileType)
    {
        return fileType.ToLower() switch
        {
            ".pdf" => "text-danger",
            ".docx" => "text-primary",
            ".xlsx" => "text-success",
            _ => "text-secondary"
        };
    }
}